{% extends "base.html" %} {% block title %}Analysis Result{% endblock %} {%
block content %}

<!-- Bootstrap CDN (only if not already in base.html) -->
<link
  href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
  rel="stylesheet"
/>

<div class="container mt-5">
  <div class="card shadow-sm mx-auto" style="max-width: 650px">
    <div class="card-body text-center">
      <h2 class="mb-4">Phishing Email Detector</h2>

      <p><strong>Email Author:</strong> {{ author }}</p>
      <p><strong>Submitted Email:</strong></p>
      <p>{{ email }}</p>

      <h4 class="mt-4">Phishing Probability:</h4>
      <canvas
        id="phishingChart"
        width="300"
        height="300"
        class="mx-auto d-block mb-4"
      ></canvas>

      {% if author_flag_count >= 1 %}
      <div class="alert alert-danger" role="alert">
        ⚠️ This sender has sent suspicious emails before ({{ author_flag_count
        }} time{{ 's' if author_flag_count > 1 else '' }}).
      </div>
      {% endif %} {% if ai_explanation %}
      <div class="alert alert-info mt-4 text-start">
        <h5 class="mb-2">💡 AI Analysis:</h5>
        <p>{{ ai_explanation }}</p>
      </div>
      {% endif %}

      <div class="d-flex justify-content-center gap-2 mt-3">
        <a href="{{ url_for('index') }}" class="btn btn-primary"
          >Analyze Another Email</a
        >
        <a href="{{ url_for('history') }}" class="btn btn-secondary"
          >View Scan History</a
        >
      </div>
    </div>
  </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  window.onload = function () {
    const phishingScore = parseInt("{{ score }}");

    const color =
      phishingScore >= 70
        ? "#dc3545"
        : phishingScore >= 30
        ? "#fd7e14"
        : "#28a745";

    const ctx = document.getElementById("phishingChart").getContext("2d");

    const centerTextPlugin = {
      id: "centerText",
      beforeDraw(chart, args, options) {
        const { width, height, ctx } = chart;
        ctx.save();
        ctx.font = "bold 24px Arial";
        ctx.fillStyle = options.color || "#000";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(phishingScore + "%", width / 2, height / 2);
        ctx.restore();
      },
    };

    new Chart(ctx, {
      type: "doughnut",
      data: {
        labels: ["Phishing Probability", "Remaining"],
        datasets: [
          {
            data: [phishingScore, 100 - phishingScore],
            backgroundColor: [color, "#e9ecef"],
            borderWidth: 1,
          },
        ],
      },
      options: {
        responsive: false,
        cutout: "80%",
        plugins: {
          legend: { display: false },
          tooltip: { enabled: false },
          centerText: { color: color },
        },
      },
      plugins: [centerTextPlugin],
    });
  };
</script>

{% endblock %}
